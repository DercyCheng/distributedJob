# 使用指南

本文档提供 DistributedJob 的详细使用说明和示例。

## 网页控制台

DistributedJob 提供了一个直观的网页控制台，用于管理定时任务、部门、用户及权限。控制台界面可通过访问 `http://localhost:9088/v1/web/` 打开。

### 登录系统

1. 访问网页控制台地址 `http://localhost:9088/v1/web/`
2. 使用管理员账号（默认用户名：`admin`，密码：`admin123`）登录系统
3. 首次登录后建议修改默认密码以提高安全性

### 部门管理

#### 查看部门列表

1. 在左侧菜单栏中点击"部门管理"
2. 系统以树形结构显示所有部门，包含以下信息：
   - 部门名称
   - 部门描述
   - 状态（启用/禁用）
   - 创建时间
   - 操作（编辑、添加子部门、删除）

#### 创建部门

1. 在部门列表页面，点击"新建部门"按钮可创建顶级部门
2. 在现有部门行中，点击"添加子部门"可创建子部门
3. 在弹出的表单中填写部门信息：
   - 部门名称：部门的名称
   - 部门描述：关于部门的详细描述（可选）
   - 上级部门：选择上级部门（创建子部门时自动选择）
   - 状态：启用或禁用
4. 点击"保存"按钮完成创建

#### 编辑部门

1. 在部门列表中，点击对应部门行的"编辑"按钮
2. 在弹出的表单中修改部门信息
3. 点击"保存"按钮提交修改

#### 删除部门

1. 在部门列表中，点击对应部门行的"删除"按钮
2. 在确认对话框中点击"确定"完成删除
   - 注意：只有没有子部门且没有关联任务的部门才能被删除

### 用户与权限管理

#### 用户管理

1. 在左侧菜单栏中点击"用户管理"
2. 系统显示所有用户列表，包含以下信息：
   - 用户名
   - 真实姓名
   - 所属部门
   - 角色
   - 状态（启用/禁用）
   - 操作（编辑、删除、重置密码）

#### 创建用户

1. 在用户列表页面，点击"新建用户"按钮
2. 在弹出的表单中填写用户信息：
   - 用户名：登录系统使用的用户名
   - 密码：初始登录密码
   - 真实姓名：用户的真实姓名
   - 电子邮箱：用户的邮箱地址（可选）
   - 手机号码：用户的联系电话（可选）
   - 所属部门：选择用户所属的部门
   - 角色：选择用户的角色（决定用户的权限）
   - 状态：启用或禁用
3. 点击"保存"按钮完成创建

#### 角色管理

1. 在左侧菜单栏中点击"角色管理"
2. 系统显示所有角色列表，包含以下信息：
   - 角色名称
   - 角色描述
   - 状态（启用/禁用）
   - 操作（编辑、删除）

#### 创建角色

1. 在角色列表页面，点击"新建角色"按钮
2. 在弹出的表单中填写角色信息：
   - 角色名称：角色的名称
   - 角色描述：关于角色的详细描述（可选）
   - 权限列表：为角色分配权限（可多选）
   - 状态：启用或禁用
3. 点击"保存"按钮完成创建

### 任务管理

#### 任务列表

任务列表页面显示了系统中所有的定时任务，包括以下信息：

- 任务ID：系统自动生成的唯一标识
- 任务名称：用户定义的任务名称
- 任务类型：HTTP 或 gRPC
- 所属部门：任务归属的部门
- Cron 表达式：定义任务执行时间的 cron 表达式
- 目标：HTTP 任务显示 URL，gRPC 任务显示服务和方法
- 状态：任务的当前状态（启用/禁用）
- 操作：可对任务进行的操作（编辑、删除、查看记录）

#### 创建 HTTP 任务

1. 在任务列表页面，点击"新建任务"按钮
2. 选择任务类型为"HTTP 任务"
3. 在弹出的表单中填写任务信息：
   - 任务名称：给任务起一个有意义的名称
   - 所属部门：选择任务归属的部门
   - Cron 表达式：定义任务执行的时间规则
   - HTTP 方法：选择 GET、POST、PUT、PATCH 或 DELETE
   - 目标 URL：任务执行时调用的 URL
   - 请求体（可选）：对于 POST/PUT/PATCH 请求，可设置请求体内容
   - 请求头（可选）：可设置自定义 HTTP 请求头
   - 重试配置（可选）：
     - 最大重试次数：执行失败时的重试次数
     - 重试间隔时间：两次重试之间的间隔秒数
     - 备用 URL：当多次重试仍失败时使用的备用 URL
   - 任务状态：启用或禁用
4. 点击"保存"按钮提交任务

#### 创建 gRPC 任务

1. 在任务列表页面，点击"新建任务"按钮
2. 选择任务类型为"gRPC 任务"
3. 在弹出的表单中填写任务信息：
   - 任务名称：给任务起一个有意义的名称
   - 所属部门：选择任务归属的部门
   - Cron 表达式：定义任务执行的时间规则
   - gRPC 服务：目标 gRPC 服务名称，格式为"package.Service"
   - gRPC 方法：要调用的方法名称
   - gRPC 参数（可选）：调用方法时传递的参数，JSON 格式
   - 重试配置（可选）：
     - 最大重试次数：执行失败时的重试次数
     - 重试间隔时间：两次重试之间的间隔秒数
     - 备用 gRPC 服务：备用服务名称
     - 备用 gRPC 方法：备用方法名称
   - 任务状态：启用或禁用
4. 点击"保存"按钮提交任务

#### 编辑任务

1. 在任务列表中，点击对应任务行的"编辑"按钮
2. 在弹出的表单中修改任务信息（表单内容根据任务类型不同而异）
3. 点击"保存"按钮提交修改

#### 删除任务

1. 在任务列表中，点击对应任务行的"删除"按钮
2. 在确认对话框中点击"确定"完成删除

### 任务执行历史

#### 查看执行记录

1. 在任务列表中，点击对应任务行的"记录"按钮
2. 在记录页面可查看该任务的所有执行记录，包括：
   - 执行时间
   - 任务类型（HTTP 或 gRPC）
   - 执行结果（成功/失败）
   - 状态码（HTTP 状态码或 gRPC 状态码）
   - 响应内容
   - 执行耗时
   - 重试次数
   - 是否使用了备用调用

#### 任务执行统计

1. 在左侧菜单栏中点击"执行统计"
2. 选择年份和月份
3. 系统显示本月任务执行的统计信息：
   - 总执行次数
   - 成功次数和成功率
   - 失败次数和失败率
   - 平均执行耗时
   - 每日执行统计图表
   - 部门任务执行分布图表

## Cron 表达式说明

DistributedJob 使用标准的 cron 表达式来定义任务的执行时间。cron 表达式由 5 或 6 个字段组成，字段之间用空格分隔：

```
┌───────────── 分钟 (0 - 59)
│ ┌───────────── 小时 (0 - 23)
│ │ ┌───────────── 日期 (1 - 31)
│ │ │ ┌───────────── 月份 (1 - 12)
│ │ │ │ ┌───────────── 星期 (0 - 6) (星期日为 0)
│ │ │ │ │
│ │ │ │ │
* * * * *
```

### 特殊字符

- `*` : 表示所有可能的值
- `,` : 用于分隔多个值（如：1,5,10）
- `-` : 表示一个范围（如：1-5）
- `/` : 指定间隔频率（如：*/5 表示每 5 个单位）

### 示例

- `* * * * *` : 每分钟执行一次
- `0 * * * *` : 每小时的第 0 分执行一次
- `0 0 * * *` : 每天午夜 00:00 执行一次
- `0 0 * * 1` : 每周一午夜 00:00 执行一次
- `0 0 1 * *` : 每月 1 日午夜 00:00 执行一次
- `0 0 1 1 *` : 每年 1 月 1 日午夜 00:00 执行一次
- `*/10 * * * *` : 每 10 分钟执行一次
- `0 9-17 * * *` : 工作时间内（上午 9 点至下午 5 点）每小时执行一次
- `0 9-17/2 * * *` : 工作时间内每两小时执行一次
- `0 9 * * 1-5` : 周一至周五上午 9 点执行一次

## API 接口使用

除了网页控制台外，DistributedJob 也提供了 RESTful API 接口，可用于程序化管理任务和部门。所有 API 都需要通过认证才能访问。

### 认证和授权

#### 登录获取 Token

```
POST http://localhost:9088/v1/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}
```

响应示例：

```json
{
  "code": 0,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 1,
      "username": "admin",
      "realName": "系统管理员",
      "departmentId": 1,
      "departmentName": "技术部",
      "roleId": 1,
      "roleName": "管理员"
    }
  },
  "message": "success"
}
```

后续的所有 API 请求都需要在 HTTP 头中添加获取到的 token：

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 部门管理 API

#### 获取部门列表

```
GET http://localhost:9088/v1/departments
Authorization: Bearer <your-token>
```

响应示例：

```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "name": "总部",
      "description": "总部",
      "parentId": null,
      "children": [
        {
          "id": 2,
          "name": "技术部",
          "description": "负责系统研发和维护",
          "parentId": 1,
          "status": 1,
          "createTime": "2023-01-01T10:00:00Z",
          "updateTime": "2023-01-02T15:30:00Z"
        }
      ],
      "status": 1,
      "createTime": "2023-01-01T10:00:00Z",
      "updateTime": "2023-01-02T15:30:00Z"
    }
  ],
  "message": "success"
}
```

### 任务管理 API

#### 获取任务列表

```
GET http://localhost:9088/v1/tasks?departmentId=2&taskType=HTTP
Authorization: Bearer <your-token>
```

响应示例：

```json
{
  "code": 0,
  "data": {
    "tasks": [
      {
        "id": 1,
        "name": "每日数据统计",
        "departmentId": 2,
        "departmentName": "技术部",
        "taskType": "HTTP",
        "cron": "0 1 * * *",
        "url": "http://example.com/api/stats",
        "httpMethod": "GET",
        "body": "",
        "headers": "{\"Authorization\":\"Bearer token123\"}",
        "retryCount": 3,
        "retryInterval": 60,
        "fallbackUrl": "http://backup.example.com/api/stats",
        "status": 1,
        "createTime": "2023-01-01T10:00:00Z",
        "updateTime": "2023-01-02T15:30:00Z",
        "createBy": "admin",
        "updateBy": "admin"
      }
    ],
    "total": 1,
    "page": 1,
    "size": 10
  },
  "message": "success"
}
```

#### 创建 HTTP 任务

```
POST http://localhost:9088/v1/tasks/http
Content-Type: application/json
Authorization: Bearer <your-token>

{
  "name": "每日数据统计",
  "departmentId": 2,
  "cron": "0 1 * * *",
  "url": "http://example.com/api/stats",
  "httpMethod": "GET",
  "body": "",
  "headers": "{\"Authorization\":\"Bearer token123\"}",
  "retryCount": 3,
  "retryInterval": 60,
  "fallbackUrl": "http://backup.example.com/api/stats",
  "status": 1
}
```

响应示例：

```json
{
  "code": 0,
  "data": {
    "id": 1
  },
  "message": "success"
}
```

#### 创建 gRPC 任务

```
POST http://localhost:9088/v1/tasks/grpc
Content-Type: application/json
Authorization: Bearer <your-token>

{
  "name": "用户数据同步",
  "departmentId": 3,
  "cron": "0 0 * * *",
  "grpcService": "user.UserService",
  "grpcMethod": "SyncUserData",
  "grpcParams": "{\"source\":\"main_db\"}",
  "retryCount": 3,
  "retryInterval": 60,
  "fallbackGrpcService": "user.BackupUserService",
  "fallbackGrpcMethod": "SyncUserData",
  "status": 1
}
```

响应示例：

```json
{
  "code": 0,
  "data": {
    "id": 2
  },
  "message": "success"
}
```

### 执行记录查询 API

#### 获取任务执行记录

```
GET http://localhost:9088/v1/records?taskId=1&departmentId=2&year=2025&month=1&page=1&size=10&taskType=HTTP
Authorization: Bearer <your-token>
```

参数说明：
- `taskId`：任务ID（可选）
- `departmentId`：部门ID（可选）
- `year`：年份，如 2025（必填）
- `month`：月份，如 1-12（必填）
- `page`：页码，从 1 开始（可选，默认为 1）
- `size`：每页记录数（可选，默认为 10）
- `taskType`：任务类型，HTTP 或 GRPC（可选）

响应示例：

```json
{
  "code": 0,
  "data": {
    "records": [
      {
        "id": 1,
        "taskId": 1,
        "taskName": "每日数据统计",
        "taskType": "HTTP",
        "departmentId": 2,
        "departmentName": "技术部",
        "url": "http://example.com/api/stats",
        "httpMethod": "GET",
        "body": "",
        "headers": "{\"Authorization\":\"Bearer token123\"}",
        "response": "{\"status\":\"success\"}",
        "statusCode": 200,
        "success": true,
        "retryTimes": 0,
        "useFallback": false,
        "costTime": 120,
        "createTime": "2025-01-01T01:00:00Z"
      }
    ],
    "total": 30,
    "page": 1,
    "size": 10
  },
  "message": "success"
}
```

## 最佳实践

### 部门和权限管理最佳实践

1. **部门结构设计**
   - 按照公司实际组织架构设计部门层级
   - 避免过深的层级结构，一般不超过 3-4 层
   - 可以为不同业务线或产品线创建独立部门

2. **角色权限设计**
   - 遵循最小权限原则，只授予用户必需的权限
   - 为不同职能创建专门的角色，如开发、运维、管理等
   - 定期审查角色权限，及时调整不合理的权限设置

3. **用户管理**
   - 员工离职时及时禁用账号
   - 定期检查长期未使用的账号
   - 强制要求使用强密码并定期更换

### 任务管理最佳实践

1. **任务命名规范**
   - 使用有意义的名称，明确表示任务的用途
   - 可以在名称前添加业务分类和部门前缀，如 `[技术部-数据统计] 每日活跃用户统计`
   - 避免使用特殊字符，使用中文或英文均可

2. **任务类型选择**
   - 对于简单的 RESTful 接口调用，使用 HTTP 任务
   - 对于需要强类型参数和返回值的场景，优先使用 gRPC 任务
   - 对于大型复杂任务，可考虑使用 gRPC 任务以获得更好的性能

3. **Cron 表达式优化**
   - 避免设置过于频繁的执行计划，会增加系统负担
   - 对于大型批处理任务，建议安排在系统负载较低的时间段执行（如深夜）
   - 多个任务的执行时间尽量错开，避免同一时刻执行过多任务
   - 为不同部门的任务设置不同的执行时间窗口

4. **异常处理建议**
   - 为重要任务设置合理的重试策略
   - 提供备用 URL 或备用 gRPC 服务，作为主要调用失败时的备选方案
   - 定期检查任务的执行记录，及时发现并解决问题

5. **任务执行历史管理**
   - 定期查看和分析任务执行历史，优化执行效率
   - 对于频繁失败的任务，及时调整参数或修复问题
   - 利用执行历史统计功能，分析任务执行的趋势和模式

### 安全建议

1. **接口安全**
   - 使用 HTTPS 而非 HTTP 进行任务调用
   - 在请求头中添加认证信息，如 API Key 或 Token
   - 限制 API 的访问来源，只允许特定 IP 访问

2. **数据安全**
   - 敏感数据在存储和传输过程中进行加密
   - 定期备份系统数据，特别是任务配置和关键执行记录
   - 实施访问控制，确保用户只能访问其权限范围内的数据

3. **系统安全**
   - 定期更新系统组件和依赖库，修复已知安全漏洞
   - 开启防火墙，限制不必要的端口访问
   - 记录系统访问日志，便于追踪异常操作

## 常见问题及解决方案

### Q: 如何在多部门环境中管理任务？

A: 在多部门环境中管理任务可以遵循以下步骤：
1. 为每个部门创建对应的部门节点和子部门结构
2. 为不同部门的管理人员创建对应的用户账号，并分配适当的角色和权限
3. 任务应创建在其所属的业务部门下，便于部门管理员管理和监控
4. 可利用API实现跨部门的任务批量操作和监控

### Q: 如何选择 HTTP 任务和 gRPC 任务？

A: 选择任务类型时可参考以下原则：
1. HTTP 任务适合：
   - 调用 RESTful API
   - 简单的数据交换
   - 与第三方系统集成
   - 不需要强类型检查的场景

2. gRPC 任务适合：
   - 内部服务间的调用
   - 需要高性能的场景
   - 需要强类型定义的场景
   - 数据量较大的场景

### Q: 如何调试定时任务？

A: 可以通过以下方式调试定时任务：
1. 将任务的 cron 表达式临时修改为近期时间点
2. 查看任务执行记录，检查响应内容和状态码/gRPC状态
3. 在目标服务中添加日志记录，便于追踪问题
4. 使用执行历史功能，分析任务的执行情况和性能

### Q: 任务执行失败怎么办？

A: 当任务执行失败时：
1. 查看执行记录，了解失败原因（如 HTTP 状态码、gRPC 状态码、响应内容）
2. 检查目标是否可访问，可能是网络问题或目标服务异常
3. 检查任务配置，特别是 URL/服务名称、方法、参数等是否正确
4. 为重要任务配置重试机制和备用调用

### Q: 如何备份和迁移整个系统配置？

A: 可以通过以下方式备份和迁移系统配置：
1. 使用数据库备份工具，备份整个数据库
2. 使用 API 接口导出部门、角色、用户、任务等配置信息
3. 创建迁移脚本，自动化迁移过程
4. 在迁移后，验证所有配置是否正确，尤其是部门结构和权限设置
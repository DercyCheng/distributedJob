# 使用指南

<div align="center">
  <h3>DistributedJob 使用指南</h3>
</div>

本指南提供了使用 DistributedJob 的详细说明，包括 Web 控制台和 API 接口。

## 目录

- [Web 控制台](#web-控制台)
  - [登录](#登录)
  - [部门管理](#部门管理)
  - [用户和权限管理](#用户和权限管理)
  - [任务管理](#任务管理)
  - [执行历史](#执行历史)
- [Cron 表达式指南](#cron-表达式指南)
- [API 使用](#api-使用)
- [最佳实践](#最佳实践)
- [常见问题](#常见问题)

## Web 控制台

DistributedJob 提供了直观的 Web 控制台，用于管理定时任务、部门、用户和权限。访问控制台地址：`http://localhost:9088/v1/web/`。

### 登录

1. 访问 `http://localhost:9088/v1/web/`
2. 输入默认凭据：
   - 用户名：`admin`
   - 密码：`admin123`
3. 出于安全考虑，请在首次登录后更改默认密码

![登录界面](../assets/images/login-screen.png)

### 部门管理

部门可以帮助组织任务并控制跨组织的访问权限。

#### 查看部门

1. 点击左侧边栏中的"部门管理"
2. 查看显示所有部门的树状结构，包含：
   - 部门名称
   - 描述
   - 状态（启用/禁用）
   - 创建时间
   - 可用操作

![部门列表](../assets/images/department-list.png)

#### 创建部门

1. 点击"新建部门"创建顶级部门
2. 在现有部门上点击"添加子部门"创建子部门
3. 填写表单：
   - 部门名称
   - 描述（可选）
   - 父部门（创建子部门时自动选择）
   - 状态（启用/禁用）
4. 点击"保存"

![创建部门](../assets/images/create-department.png)

#### 编辑部门

1. 点击部门行上的"编辑"按钮
2. 根据需要修改信息
3. 点击"保存"

#### 删除部门

1. 点击部门行上的"删除"按钮
2. 在对话框中确认删除
   - 注意：无法删除有子部门或关联任务的部门

### 用户和权限管理

#### 用户管理

1. 点击左侧边栏中的"用户管理"
2. 查看所有用户，包含：
   - 用户名
   - 真实姓名
   - 部门
   - 角色
   - 状态
   - 可用操作

![用户列表](../assets/images/user-list.png)

#### 创建用户

1. 点击"新建用户"
2. 填写表单：
   - 用户名
   - 密码
   - 真实姓名
   - 邮箱（可选）
   - 电话号码（可选）
   - 部门
   - 角色
   - 状态
3. 点击"保存"

![创建用户](../assets/images/create-user.png)

#### 角色管理

1. 点击左侧边栏中的"角色管理"
2. 查看所有角色，包含：
   - 角色名称
   - 描述
   - 状态
   - 可用操作

#### 创建角色

1. 点击"新建角色"
2. 填写表单：
   - 角色名称
   - 描述（可选）
   - 权限（可选择多个）
   - 状态
3. 点击"保存"

![创建角色](../assets/images/create-role.png)

### 任务管理

#### 任务列表

任务列表显示所有计划任务，包含：

- 任务 ID
- 任务名称
- 类型（HTTP 或 gRPC）
- 部门
- Cron 表达式
- 目标（URL 或 gRPC 服务/方法）
- 状态
- 可用操作

![任务列表](../assets/images/task-list.png)

#### 创建 HTTP 任务

1. 点击"新建任务"
2. 选择"HTTP 任务"
3. 填写表单：
   - 任务名称
   - 部门
   - Cron 表达式
   - HTTP 方法（GET、POST、PUT、PATCH、DELETE）
   - 目标 URL
   - 请求体（适用于 POST/PUT/PATCH）
   - 请求头（可选）
   - 重试配置（可选）：
     - 最大重试次数
     - 重试间隔（秒）
     - 备用 URL
   - 任务状态
4. 点击"保存"

![创建 HTTP 任务](../assets/images/create-http-task.png)

#### 创建 gRPC 任务

1. 点击"新建任务"
2. 选择"gRPC 任务"
3. 填写表单：
   - 任务名称
   - 部门
   - Cron 表达式
   - gRPC 服务（格式："package.Service"）
   - gRPC 方法
   - gRPC 参数（JSON 格式，可选）
   - 重试配置（可选）：
     - 最大重试次数
     - 重试间隔（秒）
     - 备用 gRPC 服务
     - 备用 gRPC 方法
   - 任务状态
4. 点击"保存"

![创建 gRPC 任务](../assets/images/create-grpc-task.png)

#### 编辑任务

1. 点击任务行上的"编辑"按钮
2. 根据需要修改信息（表单根据任务类型而异）
3. 点击"保存"

#### 删除任务

1. 点击任务行上的"删除"按钮
2. 在对话框中确认删除

### 执行历史

#### 查看执行记录

1. 点击任务行上的"记录"按钮
2. 查看该任务的所有执行记录：
   - 执行时间
   - 类型（HTTP 或 gRPC）
   - 结果（成功/失败）
   - 状态码
   - 响应内容
   - 执行耗时
   - 重试次数
   - 备用使用情况

![执行记录](../assets/images/execution-records.png)

#### 执行统计

1. 点击左侧边栏中的"执行统计"
2. 选择年份和月份
3. 查看月度任务执行统计：
   - 总执行次数
   - 成功次数和成功率
   - 失败次数和失败率
   - 平均执行时间
   - 每日执行图表
   - 部门执行分布图表

![执行统计](../assets/images/execution-statistics.png)

## Cron 表达式指南

DistributedJob 使用标准 Cron 表达式定义任务执行计划。Cron 表达式由 5 或 6 个字段组成，用空格分隔：

```
┌───────────── 分钟 (0 - 59)
│ ┌───────────── 小时 (0 - 23)
│ │ ┌───────────── 月份中的日期 (1 - 31)
│ │ │ ┌───────────── 月份 (1 - 12)
│ │ │ │ ┌───────────── 星期几 (0 - 6) (星期日 = 0)
│ │ │ │ │
│ │ │ │ │
* * * * *
```

### 特殊字符

- `*`：任意值
- `,`：值列表分隔符（例如，1,5,10）
- `-`：范围值（例如，1-5）
- `/`：步长值（例如，*/5 表示每 5 个单位）

### 常见示例

| 表达式 | 描述 |
|------------|-------------|
| `* * * * *` | 每分钟 |
| `0 * * * *` | 每小时的第 0 分钟 |
| `0 0 * * *` | 每天午夜（00:00） |
| `0 0 * * 1` | 每周一午夜 |
| `0 0 1 * *` | 每月第一天午夜 |
| `0 0 1 1 *` | 1月1日午夜（每年） |
| `*/10 * * * *` | 每 10 分钟 |
| `0 9-17 * * *` | 上午 9 点至下午 5 点的每小时整点 |
| `0 9-17/2 * * *` | 上午 9 点至下午 5 点，每两小时 |
| `0 9 * * 1-5` | 每个工作日（周一至周五）上午 9 点 |

## API 使用

除了 Web 控制台，DistributedJob 还提供了 RESTful API 用于编程管理。所有 API 使用 JSON 进行数据交换。

### 认证

#### 登录获取令牌

```
POST http://localhost:9088/v1/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}
```

响应：

```json
{
  "code": 0,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 1,
      "username": "admin",
      "realName": "系统管理员",
      "departmentId": 1,
      "departmentName": "IT部门",
      "roleId": 1,
      "roleName": "管理员"
    }
  },
  "message": "success"
}
```

所有后续请求都应在 Authorization 头中包含令牌：

```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 部门 API 示例

#### 获取部门列表

```
GET http://localhost:9088/v1/departments
Authorization: Bearer <your-token>
```

### 任务 API 示例

#### 获取任务列表

```
GET http://localhost:9088/v1/tasks?departmentId=2&taskType=HTTP
Authorization: Bearer <your-token>
```

#### 创建 HTTP 任务

```
POST http://localhost:9088/v1/tasks/http
Content-Type: application/json
Authorization: Bearer <your-token>

{
  "name": "每日统计",
  "departmentId": 2,
  "cron": "0 1 * * *",
  "url": "http://example.com/api/stats",
  "httpMethod": "GET",
  "body": "",
  "headers": "{\"Authorization\":\"Bearer token123\"}",
  "retryCount": 3,
  "retryInterval": 60,
  "fallbackUrl": "http://backup.example.com/api/stats",
  "status": 1
}
```

完整 API 参考，请查看 [API 参考](./api.md)。

## 最佳实践

### 部门和权限最佳实践

1. **部门结构设计**
   - 遵循实际组织结构
   - 避免过深的层次（不超过 3-4 层）
   - 为不同的业务线或产品创建单独的部门

2. **角色权限设计**
   - 遵循最小权限原则
   - 为不同职能创建特定角色（开发、运维等）
   - 定期审查和调整权限

3. **用户管理**
   - 员工离职时立即禁用账户
   - 定期检查不活跃账户
   - 强制实施强密码策略

### 任务管理最佳实践

1. **任务命名约定**
   - 使用清晰表明用途的有意义名称
   - 考虑添加部门或分类前缀：`[IT-数据统计] 日活用户`
   - 避免特殊字符

2. **任务类型选择**
   - 对于简单的 RESTful API 调用使用 HTTP 任务
   - 对于需要类型化参数/返回值的场景，选择 gRPC 任务
   - 对于大型、复杂任务，考虑使用 gRPC 以获得更好的性能

3. **Cron 表达式优化**
   - 避免过于频繁的执行以减轻系统负载
   - 在非高峰时段安排大型批处理任务
   - 错开任务执行时间以避免并发负载峰值
   - 为不同部门设置不同的执行时间窗口

4. **异常处理建议**
   - 为重要任务配置适当的重试策略
   - 为关键任务提供备用 URL 或 gRPC 服务
   - 定期检查执行记录以识别和解决问题

5. **执行历史管理**
   - 定期审查执行历史以优化效率
   - 调整参数或修复经常失败的任务的问题
   - 使用执行统计分析趋势和模式

### 安全建议

1. **接口安全**
   - 使用 HTTPS 而不是 HTTP 进行任务调用
   - 添加身份验证头，如 API 密钥或令牌
   - 限制 API 访问到特定 IP

2. **数据安全**
   - 在存储和传输中加密敏感数据
   - 定期备份系统数据，尤其是任务配置
   - 实施访问控制，确保用户只能访问其权限范围内的数据

3. **系统安全**
   - 定期更新系统组件和依赖项
   - 启用防火墙并限制不必要的端口访问
   - 记录系统访问以用于审计

## 常见问题

### 问：如何在多部门环境中管理任务？

答：按照以下步骤操作：
1. 创建匹配组织结构的部门节点和子部门
2. 为部门经理创建具有适当角色和权限的用户账户
3. 在相关业务部门下创建任务
4. 使用 API 进行跨部门批量操作和监控

### 问：如何选择 HTTP 和 gRPC 任务？

答：考虑以下指南：
1. 以下情况使用 HTTP 任务：
   - RESTful API 调用
   - 简单数据交换
   - 第三方系统集成
   - 不需要严格类型检查的场景

2. 以下情况使用 gRPC 任务：
   - 内部服务调用
   - 高性能场景
   - 需要严格类型定义的场景
   - 大数据量场景

### 问：如何调试计划任务？

答：尝试以下调试方法：
1. 临时修改 Cron 表达式，使任务在近期运行
2. 检查执行记录中的响应内容和状态码
3. 对于频繁失败的任务，检查：
   - 连接问题
   - 认证问题
   - 服务可用性
   - 参数格式错误
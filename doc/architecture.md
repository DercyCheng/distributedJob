# 架构设计

<div align="center">
  <img src="../assets/images/logo.png" alt="DistributedJob Logo" width="200" />
  <h3>DistributedJob 架构设计</h3>
</div>

## 📋 概述

DistributedJob 采用模块化设计，围绕几个核心组件构建，这些组件共同协作，提供可靠且可扩展的分布式调度系统。

## 🏗️ 核心组件

1. **API 层** - 用于任务/部门/用户管理的 RESTful API 端点
2. **调度引擎** - 处理任务调度和分发
3. **存储层** - 持久化任务配置和执行记录
4. **Web 控制台** - 提供可视化管理界面
5. **认证/权限模块** - 管理身份验证和授权
6. **任务执行器** - 执行 HTTP 和 gRPC 任务，支持重试
7. **历史记录管理器** - 记录和分析任务执行历史

## 📁 项目结构

```
distributedJob/
├── cmd/                  # 命令行应用程序入口点
│   └── server/           # 服务器应用程序
│       └── main.go       # 主程序入口点
├── internal/             # 私有应用程序和库代码
│   ├── api/              # API 相关代码
│   │   ├── handler/      # HTTP 处理器
│   │   ├── middleware/   # HTTP 中间件
│   │   ├── router.go     # HTTP 路由定义
│   │   └── server.go     # API 服务器
│   ├── auth/             # 认证和授权
│   │   ├── department.go # 部门管理
│   │   ├── permission.go # 权限控制
│   │   └── user.go       # 用户管理
│   ├── config/           # 配置管理
│   │   └── config.go     # 配置结构和加载逻辑
│   ├── job/              # 核心任务调度模块
│   │   ├── scheduler.go  # 任务调度器
│   │   ├── task.go       # 任务定义和管理
│   │   ├── http_worker.go # HTTP 任务执行器
│   │   ├── grpc_worker.go # gRPC 任务执行器
│   │   └── history.go    # 任务执行历史记录
│   ├── model/            # 数据模型
│   │   ├── dto/          # 数据传输对象
│   │   └── entity/       # 业务实体对象
│   ├── store/            # 存储层
│   │   ├── mysql/        # MySQL 实现
│   │   │   └── repository/  # 数据访问对象
│   │   └── repository.go # 存储接口定义
│   └── service/          # 业务逻辑服务
│       ├── task_service.go  # 任务服务实现
│       ├── department_service.go  # 部门服务实现
│       └── history_service.go  # 历史记录服务实现
├── pkg/                  # 可被外部应用程序使用的库
│   ├── logger/           # 日志工具
│   └── utils/            # 通用工具函数
├── web/                  # Web 前端资源
│   ├── assets/           # 静态资源 (CSS, JS 等)
│   ├── templates/        # HTML 模板
│   └── public/           # 公开访问文件
├── configs/              # 配置文件目录
│   └── config.yaml       # 主配置文件
├── scripts/              # 构建和部署脚本
├── docs/                 # 文档目录
├── go.mod                # Go 模块依赖
└── go.sum                # Go 模块校验和
```

## 📊 组件图

```
┌─────────────────────────────────────────────────────────────────┐
│                         Web 控制台                               │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                           API 层                                 │
├─────────────┬─────────────┬──────────────┬──────────────────────┤
│  任务 API    │  用户 API    │   部门 API    │    历史记录 API      │
│             │             │              │                      │
└─────────────┴─────────────┴──────────────┴──────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                          服务层                                  │
├─────────────┬─────────────┬──────────────┬──────────────────────┤
│ 任务服务     │ 用户服务     │ 部门服务      │    历史记录服务        │
│             │             │              │                      │
└─────────────┴─────────────┴──────────────┴──────────────────────┘
                                │
                 ┌──────────────┼──────────────┐
                 │              │              │
                 ▼              ▼              ▼
┌───────────────────┐ ┌──────────────────┐ ┌─────────────────────┐
│    调度引擎        │ │     认证模块      │ │      存储层          │
├───────────────────┤ └──────────────────┘ ├─────────────────────┤
│  HTTP 任务执行器   │                      │      MySQL          │
├───────────────────┤                      │                     │
│  gRPC 任务执行器   │                      │                     │
└───────────────────┘                      └─────────────────────┘
```

## 🔄 工作流程

1. **系统初始化**
   - 从 config.yaml 加载配置
   - 初始化数据库连接
   - 设置日志记录
   - 启动 HTTP 服务器
   - 初始化调度器

2. **任务调度**
   - 调度器扫描数据库中的活动任务
   - 根据 Cron 表达式组织任务
   - 当任务到期时，分发给相应的执行器

3. **任务执行**
   - 执行器（HTTP 或 gRPC）执行任务
   - 结果记录在执行历史中
   - 根据配置，失败任务可能会重试
   - 如果主要执行失败，则触发备用机制

4. **用户交互**
   - 用户通过 Web 控制台或 API 与系统交互
   - 强制执行身份验证和授权
   - 用户可以管理任务、查看历史记录并配置部门/权限

## 💡 设计原则

- **模块化**：组件设计具有明确的边界和接口
- **可扩展性**：无状态设计允许水平扩展
- **弹性**：重试机制和备用方案确保可靠性
- **安全性**：基于角色的访问控制模型，实现精细权限控制
- **可观测性**：全面的日志记录和执行历史

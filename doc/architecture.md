# 项目架构

## 整体架构

DistributedJob 采用模块化设计，主要由以下几个核心模块组成：

1. **API 模块**：提供 HTTP API 接口，包括任务管理、健康检查和服务关闭等
2. **调度引擎**：负责任务的调度和执行
3. **存储层**：负责任务数据和执行记录的持久化
4. **Web 控制台**：提供可视化的任务管理界面
5. **权限管理模块**：负责用户认证、部门管理和权限控制
6. **任务类型管理模块**：支持HTTP和gRPC等多种任务类型
7. **历史记录管理模块**：记录和管理任务执行历史

## 目录结构

```
distributedJob/
├── cmd/                  # 命令行应用入口
│   └── server/           # 服务器应用
│       └── main.go       # 主程序入口点
├── internal/             # 私有应用和库代码
│   ├── api/              # API接口相关代码
│   │   ├── handler/      # HTTP处理器
│   │   ├── middleware/   # HTTP中间件
│   │   ├── router.go     # HTTP路由定义
│   │   └── server.go     # API服务器
│   ├── auth/             # 认证和授权相关代码
│   │   ├── department.go # 部门管理
│   │   ├── permission.go # 权限控制
│   │   └── user.go       # 用户管理
│   ├── config/           # 配置管理
│   │   └── config.go     # 配置结构和加载逻辑
│   ├── job/              # 任务调度核心模块
│   │   ├── scheduler.go  # 任务调度器
│   │   ├── task.go       # 任务定义和管理
│   │   ├── http_worker.go # HTTP任务执行器
│   │   ├── grpc_worker.go # gRPC任务执行器
│   │   └── history.go    # 任务执行历史记录
│   ├── model/            # 数据模型
│   │   ├── dto/          # 数据传输对象
│   │   └── entity/       # 业务实体对象
│   ├── store/            # 存储层
│   │   ├── mysql/        # MySQL实现
│   │   │   └── repository/  # 数据访问对象
│   │   └── repository.go # 存储接口定义
│   └── service/          # 业务逻辑服务
│       ├── task_service.go  # 任务服务实现
│       ├── department_service.go  # 部门服务实现
│       └── history_service.go  # 历史记录服务实现
├── pkg/                  # 可被外部应用使用的库代码
│   ├── logger/           # 日志工具
│   └── utils/            # 通用工具函数
├── web/                  # Web前端资源
│   ├── assets/           # 静态资源(CSS、JS等)
│   ├── templates/        # HTML模板
│   └── public/           # 公开可访问的文件
├── configs/              # 配置文件目录
│   └── config.yaml       # 主配置文件
├── scripts/              # 构建和部署脚本
├── docs/                 # 文档目录
│   └── api.md            # API文档
├── go.mod                # Go模块依赖定义
└── go.sum                # Go模块依赖校验和
```

## 模块说明

### API 模块

API 模块定义了 Distributed Job 对外提供的 HTTP 接口，包括：

- 任务管理API：创建、更新、删除和查询定时任务
- 任务记录API：查询任务执行记录
- 健康检查API：用于监控服务状态
- 服务关闭API：用于优雅关闭服务实例
- 部门管理API：用于管理部门信息和部门关联的任务
- 权限管理API：用于管理用户权限和资源访问控制

### 基础功能模块

基础功能模块提供了配置管理和日志管理等基础功能：

- 配置管理：读取和解析 config.yaml 配置文件
- 日志管理：提供日志记录和管理功能

### 任务调度模块

任务调度模块是 Distributed Job 的核心，负责任务的调度和执行：

- 任务管理：任务的创建、更新和删除
- 任务调度：基于 cron 表达式的定时任务调度
- 任务执行：支持多种任务类型，包括HTTP和gRPC
- 重试机制：支持任务失败重试和备用调度地址
- 执行历史：记录任务的每次执行情况和结果

### 权限管理模块

权限管理模块负责系统的认证和授权：

- 用户管理：用户的创建、更新、删除和查询
- 部门管理：部门的创建、更新、删除和查询
- 权限控制：基于RBAC模型的权限控制，精细管理对资源的访问权限

### 数据模型

数据模型定义了系统中使用的数据结构：

- DTO（Data Transfer Object）：在不同层之间传输数据的对象
- Entity：业务实体对象，反映核心业务概念

### 存储层

存储层负责数据的持久化和查询：

- 存储接口：定义数据访问的抽象接口
- MySQL实现：提供基于MySQL的存储实现
- 数据访问对象：提供任务、执行记录、部门和权限的CRUD操作

### Web 控制台

Web 控制台提供了可视化的任务管理界面，包括：

- 任务列表：显示所有定时任务，支持按部门筛选
- 任务详情：查看和编辑任务配置
- 任务记录：查看任务执行记录
- 部门管理：管理部门信息和部门关联的任务
- 权限管理：管理用户权限和资源访问控制

## 工作流程

1. 系统启动时，加载配置文件并初始化各个模块
2. 调度引擎扫描数据库中的定时任务，并基于 cron 表达式安排执行时间
3. 当任务需要执行时，调度引擎创建执行计划并分配给相应的工作线程(HTTP或gRPC)
4. 工作线程根据任务类型执行任务，记录执行过程和结果
5. 如果任务执行失败，根据配置的重试规则进行重试
6. 执行结果存储到数据库中，作为历史记录，可通过Web控制台或API查询
7. 用户可以按部门和权限，管理和查看相关的任务和执行记录
